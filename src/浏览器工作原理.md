# 为什么打开一个页面，任务管理器中会有四个进程？

![img](https://cdn.nlark.com/yuque/0/2021/png/21510703/1638691885866-f37dc7b9-f499-4a1c-8eb8-b78c152b87b8.png)



## 进程和线程

### 什么是并行处理

计算机中的并行处理就是同一时刻处理多个任务。

```javascript
A = 1+2;
B = 20/5;
C = 7*8
```

在编写代码的时候，我们可以把这个过程拆分为四个任务：

- 任务 1 是计算 A=1+2；
- 任务 2 是计算 B=20/5；

- 任务 3 是计算 C=7*8；
- 任务 4 是显示最后计算的结果。

单线程来处理的时候，按照任务顺序分别执行这四个任务；

多线程处理的时候，分两步走：第一步，使用三个线程同事执行前三个任务；第二步，再执行第四个显示任务。

所以并行处理能大大提高性能。



### 线程 VS 进程

线程不能单独存在，是由进行来启动和管理的。一个进程就是一个程序的运行实例。

启动一个程序的时候，操作系统会被该程序创建一块内存，用来存放代码、运行中的数据和一个执行任务的主线程，这样的一个运行环境叫进程。

**线程是依附于进程的，而进程中使用多线程并行处理能提升运算效率。**



进程和线程关系之间的特点：

- 进程中的任意一线程执行出错，都会导致整个进程的崩溃
- 线程之间共享进程中的数据

- 当一个进程关闭之后，操作系统会回收进程所占用的内存
- 进程之间的内容相互隔离



## 单进程浏览器

![img](https://cdn.nlark.com/yuque/0/2021/png/21510703/1638695013003-029877e3-bf6f-429a-b3ac-2964305009d6.png)

浏览器所有功能模块都是运行在同一个进程里，这些模块包含了网络、插件、JavaScript运行环境、渲染引擎和页面等。如此多的功能模块运行在一个进程里，导致单进程浏览器不稳定、不流畅和不安全。

### 不稳定

web端的视频和游戏需要借助插件来实现各种功能，但是插件容易出现问题，并且还运行在浏览器进程之中，所以一个插件的意外崩溃会引起整个浏览器的崩溃。

一些复杂的JavaScript代码也可能引起渲染引擎模块的崩溃。

### 不流畅

```javascript
function freeze() { while (1) { console.log("freeze"); }}freeze();
```

浏览器同一时刻只能有一个模块在运行。

当代码中有一段无限循环的代码时，它会独占整个线程，这样导致其他运行在该线程中的模块就没有机会被执行。这样就会导致整个浏览器失去响应，变卡顿。

页面的内存泄露也会导致单进程变慢。

### 不安全

插件和脚本代码可以通过获取系统权限对电脑做出恶意的事情，引发安全问题



## 多进程浏览器

### 早起的多进程浏览器

![img](https://cdn.nlark.com/yuque/0/2021/png/21510703/1638695788856-965323dd-7c10-4d5b-ae37-81dcd80d42e1.png)

Chrome的页面是运行在单独的渲染进程中的，同事页面里的插件也是运行在单独的插件进程之中，而进程之间是通过IPC机制进行通信。

#### 如何解决不稳定？

由于进程之间是相互隔离的，所以当一个页面或者插件崩溃时，影响到的仅仅是当前的页面进程或插件进程，并不会影响到浏览器和其他页面。

#### 如何解决不流畅？

JavaScript也是运行在渲染进程中的，所以即使JavaScript阻塞了渲染进程，影响到的也只是当前的渲染页面。不会影响到浏览器和其他页面。

#### 如何解决不安全？

采用多进程架构就可以使用安全沙箱，沙箱可以看做是操作系统给进程上的一把锁，沙箱里的程序不会营销到沙箱外的数据、程序、系统等。Chrome把插件进程和渲染进程锁在沙箱里面，这样即使在渲染进程或者插件进程里面执行了恶意程序，恶意程序也无法突破沙箱去获取系统权限。



### 当前的多进程浏览器

![img](https://cdn.nlark.com/yuque/0/2021/png/21510703/1638696677635-448e15c5-0f67-482f-bbc0-b68bf9321bba.png)



> 最新的Chrome浏览器包括：1个浏览器（Browser）进程、1个GPU进程、1个网络（NetWork）进程、多个渲染进程和多个插件进程。

- 浏览器进程：主要负责界面显示、用户交互、子进程管理，同时提供存储等功能。
- 渲染进程：核心任务是将HTML、CSS和JavaScript转换为用户可以与之交互的网页。排版引擎Blink和JavaScript引擎V8都是运行在该进程中，Chrome 会为每个 Tab 标签创建一个渲染进程。出于安全考虑，渲染进程都是运行在沙箱模式下。

- 网络进程。主要负责页面的网络资源加载，之前是作为一个模块运行在浏览器进程里面的，直至最近才独立出来，成为一个单独的进程。
- 插件进程。主要是负责插件的运行，因插件易崩溃，所以需要通过插件进程来隔离，以保证插件进程崩溃不会对浏览器和页面造成影响。

>  打开 1 个页面至少需要 1 个网络进程、1 个浏览器进程、1 个 GPU 进程以及 1 个渲染进程，共 4 个；如果打开的页面有运行插件的话，还需要再加上 1 个插件进程。

### 多线程浏览器的问题

- 更高的资源占用。因为每个进程都会包含公共基础结构的副本（如 JavaScript 运行环境），这就意味着浏览器会消耗更多的内存资源。
- 更复杂的体系架构。浏览器各模块之间耦合性高、扩展性差等问题，会导致现在的架构已经很难适应新的需求了。



> Chrome的默认策略：每个标签对应一个渲染进程。但是如果从一个页面打开了新页面，而新页面和当前页面属于同一站点时，那么新页面会复用父页面的渲染进程。官方把这个默认策略叫process-per-site-instance。

