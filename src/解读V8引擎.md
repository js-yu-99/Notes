## 什么是V8？

是一个由Google开发的开源JavaScript引擎，目前用在Chrome浏览器和Node.js 中，其核心功能是执行易于人类理解的JavaScript代码。



## V8的核心流程

`编译`和`执行`。首先需要将JavaScript代码转换为低级中间代码或者机器能够理解的机器代码，然后再执行转换后的代码并输出执行结果。

![img](https://cdn.nlark.com/yuque/0/2021/png/21510703/1637212995261-b4d8b87a-70cf-4be9-a938-c1183e553603.png)



## 处理器如何处理高级语言？

第一种方法是解释执行，需要先将输入的源代码通过解析器编译成中间代码，之后直接使用解释器解释执行中间代码，然后直接输出结果。

![img](https://cdn.nlark.com/yuque/0/2021/png/21510703/1637213464861-d0181c5e-2669-4a99-9692-4fbe37a84a3a.png)

第二种是编译执行。采取这种方式时，也需要先将源代码转换为中间代码，然后我们的编译器再将中间代码编译成机器代码。通常编译成的机器代码是以二进制文件形式存储的，需要执行这段程序时直接执行二进制文件就可以了。还可以使用虚拟机将编译后的机器代码保存在内存中，然后直接执行内存中的二进制代码。

![img](https://cdn.nlark.com/yuque/0/2021/png/21510703/1637213576784-ca3e5768-ad2e-41d3-bc4b-e4b30de479d2.png)



执行JavaScript语言有好几种虚拟机（引擎），v8只是其中的一种。



## V8是怎么执行JavaScript代码的？

V8在执行JavaScript代码时采用的是混合编译执行和解释执行这两种手段，称为JIT（Just In Time）技术。

解释执行的启动速度快执行速度慢，而编辑执行是启动速度慢执行速度快，所以JIT结合这两种方法的有点。



![img](https://cdn.nlark.com/yuque/0/2021/png/21510703/1637213779552-5766ec86-79bf-4fc1-86fb-4545e1f00f49.png)



首先，在V8启动执行JavaScript之前，需要准备JavaScript执行时所需要的一些基础环境，包括“堆空间”、“栈空间”、“全局执行上下文”、“全局作用域”、“消息循环系统”、“内置函数”等，这些内容都是在执行JavaScript过程中需要用到的。

比如：

- 全局执行上下文包含了执行过程中的全局信息，如内置函数、全局变量等信息；
- 全局作用域包含了一些全局变量，在执行过程中的数据都需要存放在内存中；

- 还需要准备堆栈管理需要的堆栈结构。
- 初始化消息循环系统，不断接收信息并决策如何处理消息。



1. V8会接收到要执行的JavaScript源代码字符串，此时V8不能直接解读这些源码字符串，需要结构化这些字符串。

2. 源码结构化之后，生成抽象语法树（AST），生成AST的同时，还会生成相关的作用域。

3. 有了AST和作用域之后，接下来开始生成字节码，字节码是介于AST和机器代码的中间代码。

4. 解析器按照顺序解释执行字节码，并输出执行结构。

5. 监控解释器会把重复多次执行的代码标记为热点代码。

6. 当某段代码被标记为热点代码后，V8就会将这段字节码丢给优化编译器，优化编译器在后台将字节码编译为二进制代码，然后再对编译后的二进制代码执行优化操作。在之后再执行这段代码时，V8会优先选择优化之后的二进制代码，这样代码的执行速度就会大幅提升。

7. 当对象结构被动态修改时，优化后的代码就会被优化编译器反优化，恢复到解释器中解释执行。



# JavaScript函数的特点

## 函数的本质

函数是一种特殊的对象，它和对象一样可以拥有属性和值，但是函数和普通对象不同的是函数可以被调用。

![img](https://cdn.nlark.com/yuque/0/2021/png/21510703/1637324373389-7256d7d2-83c9-4043-bbec-ad714f4a5ecb.png)

在V8中，会为函数增加两个隐藏属性。`name`和`code`。

`name`属性的值就是函数名称，默认值是`anonymous`，表示该函数对象没有被设置名称。

`code`属性，表示函数代码，以字符串的形式存储在内存中。当执行到一个函数调用语句时，V8便会从函数对象中取出`code`属性值，也就是函数代码，然后再解释执行这段函数代码。



